<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Irc::Utils
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../';
  framesUrl = "../frames.html#!Irc/Utils.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (U)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Irc.html" title="Irc (module)">Irc</a></span></span>
     &raquo; 
    <span class="title">Utils</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: Irc::Utils
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb<span class="defines">,<br />
  /home/apoc/projects/ruby/rbot/lib/rbot/core/utils/parse_time.rb,<br /> /home/apoc/projects/ruby/rbot/lib/rbot/core/utils/httputil.rb,<br /> /home/apoc/projects/ruby/rbot/lib/rbot/core/utils/agent.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Miscellaneous useful functions</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Utils/ParseTime.html" title="Irc::Utils::ParseTime (module)">ParseTime</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Utils/AgentFactory.html" title="Irc::Utils::AgentFactory (class)">AgentFactory</a></span>, <span class='object_link'><a href="Utils/HttpUtil.html" title="Irc::Utils::HttpUtil (class)">HttpUtil</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="SEC_PER_MIN-constant" class="">SEC_PER_MIN =
          <div class="docstring">
  <div class="discussion">
    
<p>Seconds per minute</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>60</span></pre></dd>
      
        <dt id="SEC_PER_HR-constant" class="">SEC_PER_HR =
          <div class="docstring">
  <div class="discussion">
    
<p>Seconds per hour</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>SEC_PER_MIN</span> <span class='op'>*</span> <span class='int'>60</span></pre></dd>
      
        <dt id="SEC_PER_DAY-constant" class="">SEC_PER_DAY =
          <div class="docstring">
  <div class="discussion">
    
<p>Seconds per day</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>SEC_PER_HR</span> <span class='op'>*</span> <span class='int'>24</span></pre></dd>
      
        <dt id="SEC_PER_WK-constant" class="">SEC_PER_WK =
          <div class="docstring">
  <div class="discussion">
    
<p>Seconds per week</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>SEC_PER_DAY</span> <span class='op'>*</span> <span class='int'>7</span></pre></dd>
      
        <dt id="SEC_PER_MNTH-constant" class="">SEC_PER_MNTH =
          <div class="docstring">
  <div class="discussion">
    
<p>Seconds per (30-day) month</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>SEC_PER_DAY</span> <span class='op'>*</span> <span class='int'>30</span></pre></dd>
      
        <dt id="SEC_PER_YR-constant" class="">SEC_PER_YR =
          <div class="docstring">
  <div class="discussion">
    
<p>Second per (non-leap) year</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>SEC_PER_DAY</span> <span class='op'>*</span> <span class='int'>365</span></pre></dd>
      
        <dt id="bot-classvariable" class="">@@bot =
          
        </dt>
        <dd><pre class="code"><span class='kw'>nil</span></pre></dd>
      
        <dt id="safe_save_dir-classvariable" class="">@@safe_save_dir =
          
        </dt>
        <dd><pre class="code"><span class='kw'>nil</span></pre></dd>
      
        <dt id="html_entities-classvariable" class="">@@html_entities =
          
        </dt>
        <dd><pre class="code"><span class='const'>HTMLEntities</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#age_string-class_method" title="age_string (class method)">+ (Object) <strong>age_string</strong>(secs) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Converts age in seconds to “nn units”.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#bot-class_method" title="bot (class method)">+ (Object) <strong>bot</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The bot instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#bot%3D-class_method" title="bot= (class method)">+ (Object) <strong>bot=</strong>(b) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Set up some Utils routines which depend on the associated bot.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_location-class_method" title="check_location (class method)">+ (Object) <strong>check_location</strong>(ds, rx) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>HTML info filters often need to check if the webpage location of a passed
DataStream <em>ds</em> matches a given Regexp.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#comma_list-class_method" title="comma_list (class method)">+ (Object) <strong>comma_list</strong>(words, options = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns a comma separated list except for the last element which is joined
in with specified conjunction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#decode_html_entities-class_method" title="decode_html_entities (class method)">+ (Object) <strong>decode_html_entities</strong>(str) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_first_pars-class_method" title="get_first_pars (class method)">+ (Object) <strong>get_first_pars</strong>(urls, count, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the first pars of the first <em>count</em> <em>urls</em>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_html_info-class_method" title="get_html_info (class method)">+ (Object) <strong>get_html_info</strong>(doc, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method extracts title, content (first par) and extra information from
the given document <em>doc</em>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_resp_html_info-class_method" title="get_resp_html_info (class method)">+ (Object) <strong>get_resp_html_info</strong>(resp, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method extracts title, content (first par) and extra information from
the given Net::HTTPResponse <em>resp</em>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_string_html_info-class_method" title="get_string_html_info (class method)">+ (Object) <strong>get_string_html_info</strong>(text, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method extracts title and content (first par) from the given HTML or
XML document <em>text</em>, using standard methods
(String#ircify_html_title, Utils.ircify_first_html_par).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ircify_first_html_par-class_method" title="ircify_first_html_par (class method)">+ (Object) <strong>ircify_first_html_par</strong>(xml_org, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Try to grab and IRCify the first HTML par ( tag) in the given string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ircify_first_html_par_wh-class_method" title="ircify_first_html_par_wh (class method)">+ (Object) <strong>ircify_first_html_par_wh</strong>(xml_org, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>HTML first par grabber using hpricot.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ircify_first_html_par_woh-class_method" title="ircify_first_html_par_woh (class method)">+ (Object) <strong>ircify_first_html_par_woh</strong>(xml_org, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>HTML first par grabber without hpricot.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parse_time_offset-class_method" title="parse_time_offset (class method)">+ (Object) <strong>parse_time_offset</strong>(str) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#safe_exec-class_method" title="safe_exec (class method)">+ (Object) <strong>safe_exec</strong>(command, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Execute an external program, returning a String obtained by redirecting the
program&#39;s standards errors and output.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#safe_save-class_method" title="safe_save (class method)">+ (Object) <strong>safe_save</strong>(file) {|temp| ... }</a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Safely (atomically) save to <em>file</em>, by passing a tempfile to the
block and then moving the tempfile to its final location when done.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#secs_to_short-class_method" title="secs_to_short (class method)">+ (Object) <strong>secs_to_short</strong>(seconds) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Turn a number of seconds into a hours:minutes:seconds e.g.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#secs_to_string-class_method" title="secs_to_string (class method)">+ (Object) <strong>secs_to_string</strong>(secs) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Turn a number of seconds into a human readable string, e.g 2 days, 3 hours,
18 minutes and 10 seconds.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#secs_to_string_case-class_method" title="secs_to_string_case (class method)">+ (Object) <strong>secs_to_string_case</strong>(array, var, string, plural) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Auxiliary method needed by Utils.secs_to_string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#timeago-class_method" title="timeago (class method)">+ (Object) <strong>timeago</strong>(time, options = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns human readable time.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_exec-class_method" title="try_exec (class method)">+ (Object) <strong>try_exec</strong>(command, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Try executing an external program, returning true if the run was successful
and false otherwise.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_htmlinfo_filters-class_method" title="try_htmlinfo_filters (class method)">+ (Object) <strong>try_htmlinfo_filters</strong>(ds) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method runs an appropriately-crafted DataStream <em>ds</em> through
the filters in the :htmlinfo filter group, in order.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="age_string-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>age_string</strong>(secs) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Converts age in seconds to “nn units”. Inspired by previous attempts but
also gitweb&#39;s age_string() sub</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 248</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_age_string'>age_string</span><span class='lparen'>(</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
  <span class='kw'>case</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&lt;</span> <span class='int'>0</span>
    <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_age_string'>age_string</span><span class='lparen'>(</span><span class='op'>-</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_YR</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} years</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_YR</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_MNTH</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} months</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_MNTH</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_WK</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} weeks</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_WK</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_DAY</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} days</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_DAY</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_HR</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} hours</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_HR</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='lparen'>(</span><span class='int'>20</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='op'>..</span><span class='int'>40</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>half an hour</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='lparen'>(</span><span class='int'>50</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='op'>..</span><span class='int'>70</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
    <span class='comment'># _(&quot;about one hour&quot;)
</span>    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>an hour</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='lparen'>(</span><span class='int'>80</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='op'>..</span><span class='int'>100</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>an hour and a half</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='op'>*</span><span class='const'>SEC_PER_MIN</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} minutes</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span><span class='op'>/</span><span class='const'>SEC_PER_MIN</span> <span class='rbrace'>}</span>
  <span class='kw'>when</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>1</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{m} seconds</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span> <span class='symbol'>:m</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_secs'>secs</span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>one second</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="bot-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>bot</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The bot instance</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


147
148
149</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 147</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_bot'>bot</span>
  <span class='cvar'>@@bot</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="bot=-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>bot=</strong>(b) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Set up some Utils routines which depend on the associated bot.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


152
153
154
155
156</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 152</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_bot='>bot=</span><span class='lparen'>(</span><span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>initializing utils</span><span class='tstring_end'>&quot;</span></span>
  <span class='cvar'>@@bot</span> <span class='op'>=</span> <span class='id identifier rubyid_b'>b</span>
  <span class='cvar'>@@safe_save_dir</span> <span class='op'>=</span> <span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>safe_save</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_location-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>check_location</strong>(ds, rx) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>HTML info filters often need to check if the webpage location of a passed
DataStream <em>ds</em> matches a given Regexp.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


677
678
679
680
681
682
683
684
685</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 677</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_check_location'>check_location</span><span class='lparen'>(</span><span class='id identifier rubyid_ds'>ds</span><span class='comma'>,</span> <span class='id identifier rubyid_rx'>rx</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_ds'>ds</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='id identifier rubyid_ds'>ds</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_loc'>loc</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x-rbot-location</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>location</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_grep'>grep</span><span class='lparen'>(</span><span class='id identifier rubyid_rx'>rx</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_loc'>loc</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_loc'>loc</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_loc'>loc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="comma_list-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>comma_list</strong>(words, options = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a comma separated list except for the last element which is joined
in with specified conjunction</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


752
753
754
755
756
757
758
759
760
761</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 752</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_comma_list'>comma_list</span><span class='lparen'>(</span><span class='id identifier rubyid_words'>words</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_defaults'>defaults</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:join_with</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:join_last_with</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> and </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='id identifier rubyid_defaults'>defaults</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_words'>words</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>&lt;</span> <span class='int'>2</span>
    <span class='id identifier rubyid_words'>words</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
  <span class='kw'>else</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_words'>words</span><span class='lbracket'>[</span><span class='int'>0</span><span class='op'>..</span><span class='op'>-</span><span class='int'>2</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:join_with</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_words'>words</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:join_last_with</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="decode_html_entities-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>decode_html_entities</strong>(str) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


345
346
347</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 345</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_decode_html_entities'>decode_html_entities</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='const'>HTMLEntities</span><span class='period'>.</span><span class='id identifier rubyid_decode_entities'>decode_entities</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_first_pars-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>get_first_pars</strong>(urls, count, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the first pars of the first <em>count</em> <em>urls</em>. The pages are
downloaded using the bot httputil service. Returns an array of the first
paragraphs fetched. If (optional) <em>opts</em> :message is specified,
those paragraphs are echoed as replies to the IRC message passed as
<em>opts</em> :message</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 723</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_first_pars'>get_first_pars</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='id identifier rubyid_count'>count</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:message</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_retval'>retval</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
    <span class='id identifier rubyid_idx'>idx</span> <span class='op'>+=</span> <span class='int'>1</span>

    <span class='kw'>begin</span>
      <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_html_info'>get_html_info</span><span class='lparen'>(</span><span class='const'>URI</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>

      <span class='id identifier rubyid_par'>par</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='lbracket'>[</span><span class='symbol'>:content</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_retval'>retval</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_par'>par</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_par'>par</span>
        <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_idx'>idx</span><span class='embexpr_end'>}</span><span class='tstring_content'>] </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_par'>par</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:overlong</span> <span class='op'>=&gt;</span> <span class='symbol'>:truncate</span> <span class='kw'>if</span> <span class='id identifier rubyid_msg'>msg</span>
        <span class='id identifier rubyid_count'>count</span> <span class='op'>-=</span><span class='int'>1</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unable to retrieve </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_url'>url</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_retval'>retval</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_html_info-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>get_html_info</strong>(doc, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method extracts title, content (first par) and extra information from
the given document <em>doc</em>.</p>

<p><em>doc</em> can be an URI, a Net::HTTPResponse or a String.</p>

<p>If <em>doc</em> is a String, only title and content information are
retrieved (if possible), using standard methods.</p>

<p>If <em>doc</em> is an URI or a Net::HTTPResponse, additional information is
retrieved, and special title/summary extraction routines are used if
possible.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 592</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_html_info'>get_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_doc'>doc</span>
  <span class='kw'>when</span> <span class='const'>String</span>
    <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_string_html_info'>get_string_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPResponse</span>
    <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_resp_html_info'>get_resp_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='const'>URI</span>
    <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='const'>DataStream</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_httputil'>httputil</span><span class='period'>.</span><span class='id identifier rubyid_get_response'>get_response</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_resp'>resp</span><span class='op'>|</span>
      <span class='id identifier rubyid_ret'>ret</span><span class='period'>.</span><span class='id identifier rubyid_replace'>replace</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_resp_html_info'>get_resp_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_resp'>resp</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_ret'>ret</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_resp_html_info-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>get_resp_html_info</strong>(resp, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method extracts title, content (first par) and extra information from
the given Net::HTTPResponse <em>resp</em>.</p>

<p>Currently, the only accepted options (in <em>opts</em>) are</p>
<dl class="rdoc-list note-list"><dt>uri_fragment
<dd>
<p>the URI fragment of the original request</p>
</dd><dt>full_body
<dd>
<p>get the whole body instead of @@<a href="'http.info_bytes'">bot.config</a>
bytes only</p>
</dd></dl>

<p>Returns a DataStream with the following keys:</p>
<dl class="rdoc-list note-list"><dt>text
<dd>
<p>the (partial) body</p>
</dd><dt>title
<dd>
<p>the title of the document (if any)</p>
</dd><dt>content
<dd>
<p>the first paragraph of the document (if any)</p>
</dd><dt>headers
<dd>
<p>the headers of the Net::HTTPResponse. The value is a Hash whose keys are
lowercase forms of the HTTP header fields, and whose values are Arrays.</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 629</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_resp_html_info'>get_resp_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_resp'>resp</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_resp'>resp</span>
  <span class='kw'>when</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPSuccess</span>
    <span class='id identifier rubyid_loc'>loc</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_resp'>resp</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x-rbot-location</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_resp'>resp</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>location</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_loc'>loc</span> <span class='kw'>and</span> <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_fragment'>fragment</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_fragment'>fragment</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:uri_fragment</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_fragment'>fragment</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='const'>DataStream</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_ret'>ret</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span>
    <span class='id identifier rubyid_ret'>ret</span><span class='lbracket'>[</span><span class='symbol'>:text</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_partial'>partial</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:full_body</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>:</span> <span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_partial_body'>partial_body</span><span class='lparen'>(</span><span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>http.info_bytes</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_filtered'>filtered</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_try_htmlinfo_filters'>try_htmlinfo_filters</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_filtered'>filtered</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_filtered'>filtered</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_resp'>resp</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>content-type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^text\/|(?:x|ht)ml</span><span class='regexp_end'>/</span></span>
      <span class='id identifier rubyid_ret'>ret</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_string_html_info'>get_string_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_partial'>partial</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_ret'>ret</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>UrlLinkError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>getting link (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='embexpr_end'>}</span><span class='tstring_content'> - </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_string_html_info-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>get_string_html_info</strong>(text, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method extracts title and content (first par) from the given HTML or
XML document <em>text</em>, using standard methods
(String#ircify_html_title, Utils.ircify_first_html_par)</p>

<p>Currently, the only accepted option (in <em>opts</em>) is</p>
<dl class="rdoc-list note-list"><dt>uri_fragment
<dd>
<p>the URI fragment of the original request</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 695</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_get_string_html_info'>get_string_html_info</span><span class='lparen'>(</span><span class='id identifier rubyid_text'>text</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>getting string html info</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_text'>text</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_title'>title</span> <span class='op'>=</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html_title'>ircify_html_title</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_opts'>opts</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_frag'>frag</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:uri_fragment</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_frag'>frag</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_fragreg'>fragreg</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;a\s+(?:[^&gt;]+\s+)?(?:name|id)=[&quot;&#39;]?</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_frag'>frag</span><span class='embexpr_end'>}</span><span class='tstring_content'>[&quot;&#39;]?[^&gt;]*&gt;</span><span class='regexp_end'>/im</span></span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_fragreg'>fragreg</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_txt'>txt</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_fragreg'>fragreg</span><span class='rparen'>)</span>
      <span class='comment'># grab the post-match
</span>      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_txt'>txt</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_c_opts'>c_opts</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_c_opts'>c_opts</span><span class='lbracket'>[</span><span class='symbol'>:strip</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_title'>title</span>
  <span class='id identifier rubyid_content'>content</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par'>ircify_first_html_par</span><span class='lparen'>(</span><span class='id identifier rubyid_txt'>txt</span><span class='comma'>,</span> <span class='id identifier rubyid_c_opts'>c_opts</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_content'>content</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_content'>content</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:title</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_title'>title</span><span class='comma'>,</span> <span class='symbol'>:content</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_content'>content</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ircify_first_html_par-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>ircify_first_html_par</strong>(xml_org, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Try to grab and IRCify the first HTML par (&lt;p&gt; tag) in the given
string. If possible, grab the one after the first heading</p>

<p>It is possible to pass some options to determine how the stripping occurs.
Currently supported options are</p>
<dl class="rdoc-list note-list"><dt>strip
<dd>
<p>Regex or String to strip at the beginning of the obtained text</p>
</dd><dt>min_spaces
<dd>
<p>minimum number of spaces a paragraph should have</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


381
382
383
384
385
386
387</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 381</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par'>ircify_first_html_par</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span> <span class='op'>::</span><span class='const'>Hpricot</span>
    <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par_wh'>ircify_first_html_par_wh</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par_woh'>ircify_first_html_par_woh</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ircify_first_html_par_wh-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>ircify_first_html_par_wh</strong>(xml_org, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>HTML first par grabber using hpricot</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 390</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par_wh'>ircify_first_html_par_wh</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='const'>Hpricot</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='rparen'>)</span>

  <span class='comment'># Strip styles and scripts
</span>  <span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='op'>/</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>style|script</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_remove'>remove</span>

  <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_doc'>doc</span>

  <span class='id identifier rubyid_strip'>strip</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:strip</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_strip'>strip</span> <span class='op'>=</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^</span><span class='embexpr_beg'>#{</span><span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_escape'>escape</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:min_spaces</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>8</span>
  <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>&lt;</span> <span class='int'>0</span>

  <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='const'>String</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='id identifier rubyid_pre_h'>pre_h</span> <span class='op'>=</span> <span class='id identifier rubyid_pars'>pars</span> <span class='op'>=</span> <span class='id identifier rubyid_by_span'>by_span</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='kw'>while</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Minimum number of spaces: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_spaces'>min_spaces</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># Initial attempt: &lt;p&gt; that follows &lt;h\d&gt;
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_pre_h'>pre_h</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_pre_h'>pre_h</span> <span class='op'>=</span> <span class='const'>Hpricot</span><span class='op'>::</span><span class='const'>Elements</span><span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_found_h'>found_h</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
        <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_bogusetag?'>bogusetag?</span>
        <span class='kw'>case</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_pathname'>pathname</span>
        <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^h\d</span><span class='regexp_end'>/</span></span>
          <span class='id identifier rubyid_found_h'>found_h</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>p</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_pre_h'>pre_h</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_found_h'>found_h</span>
        <span class='kw'>end</span>
      <span class='rbrace'>}</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hx: found: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pre_h'>pre_h</span><span class='period'>.</span><span class='id identifier rubyid_pretty_inspect'>pretty_inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_pre_h'>pre_h</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_p'>p</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(Hx attempt) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
    <span class='rbrace'>}</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># Second natural attempt: just get any &lt;p&gt;
</span>    <span class='id identifier rubyid_pars'>pars</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span><span class='op'>/</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>p</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_pars'>pars</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>par: found: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pars'>pars</span><span class='period'>.</span><span class='id identifier rubyid_pretty_inspect'>pretty_inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_pars'>pars</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_p'>p</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(par attempt) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
    <span class='rbrace'>}</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># Nothing yet ... let&#39;s get drastic: we look for non-par elements too,
</span>    <span class='comment'># but only for those that match something that we know is likely to
</span>    <span class='comment'># contain text
</span>
    <span class='comment'># Some blogging and forum platforms use spans or divs with a &#39;body&#39; or
</span>    <span class='comment'># &#39;message&#39; or &#39;text&#39; in their class to mark actual text. Since we want
</span>    <span class='comment'># the class match to be partial and case insensitive, we collect
</span>    <span class='comment'># the common elements that may have this class and then filter out those
</span>    <span class='comment'># we don&#39;t need. If no divs or spans are found, we&#39;ll accept additional
</span>    <span class='comment'># elements too (td, tr, tbody, table).
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_by_span'>by_span</span> <span class='op'>=</span> <span class='const'>Hpricot</span><span class='op'>::</span><span class='const'>Elements</span><span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_extra'>extra</span> <span class='op'>=</span> <span class='const'>Hpricot</span><span class='op'>::</span><span class='const'>Elements</span><span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
        <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_bogusetag?'>bogusetag?</span>
        <span class='kw'>case</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_pathname'>pathname</span>
        <span class='kw'>when</span> <span class='const'>AFTER_PAR_PATH</span>
          <span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_el'>el</span> <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='symbol'>:class</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='const'>AFTER_PAR_CLASS</span> <span class='kw'>or</span> <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='const'>AFTER_PAR_CLASS</span>
        <span class='kw'>when</span> <span class='const'>AFTER_PAR_EX</span>
          <span class='id identifier rubyid_extra'>extra</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_el'>el</span> <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='symbol'>:class</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='const'>AFTER_PAR_CLASS</span> <span class='kw'>or</span> <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='const'>AFTER_PAR_CLASS</span>
        <span class='kw'>end</span>
      <span class='rbrace'>}</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_extra'>extra</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_concat'>concat</span> <span class='id identifier rubyid_extra'>extra</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>other \#1: found: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_pretty_inspect'>pretty_inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_by_span'>by_span</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_p'>p</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(other attempt \#1) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
    <span class='rbrace'>}</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># At worst, we can try stuff which is comprised between two &lt;br&gt;
</span>    <span class='comment'># TODO
</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Last candidate </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>/=</span> <span class='int'>2</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ircify_first_html_par_woh-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>ircify_first_html_par_woh</strong>(xml_org, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>HTML first par grabber without hpricot</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 499</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_ircify_first_html_par_woh'>ircify_first_html_par_woh</span><span class='lparen'>(</span><span class='id identifier rubyid_xml_org'>xml_org</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_xml'>xml</span> <span class='op'>=</span> <span class='id identifier rubyid_xml_org'>xml_org</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;!--.*?--&gt;</span><span class='regexp_end'>/m</span></span><span class='comma'>,</span>
                     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;script(?:\s+[^&gt;]*)?&gt;.*?&lt;\/script&gt;</span><span class='regexp_end'>/im</span></span><span class='comma'>,</span>
                     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;style(?:\s+[^&gt;]*)?&gt;.*?&lt;\/style&gt;</span><span class='regexp_end'>/im</span></span><span class='comma'>,</span>
                     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&lt;select(?:\s+[^&gt;]*)?&gt;.*?&lt;\/select&gt;</span><span class='regexp_end'>/im</span></span><span class='comma'>,</span>
                     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_strip'>strip</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:strip</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_strip'>strip</span> <span class='op'>=</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^</span><span class='embexpr_beg'>#{</span><span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_escape'>escape</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:min_spaces</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>8</span>
  <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>=</span> <span class='int'>0</span> <span class='kw'>if</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>&lt;</span> <span class='int'>0</span>

  <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='const'>String</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='kw'>while</span> <span class='kw'>true</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Minimum number of spaces: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_min_spaces'>min_spaces</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='id identifier rubyid_xml'>xml</span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='const'>HX_REGEX</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_header_found'>header_found</span>
      <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
      <span class='kw'>while</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
        <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='id identifier rubyid_header_found'>header_found</span><span class='lbracket'>[</span><span class='const'>PAR_REGEX</span><span class='rbracket'>]</span>
        <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_candidate'>candidate</span>
        <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_candidate'>candidate</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
        <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
        <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
        <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(Hx attempt) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># If we haven&#39;t found a first par yet, try to get it from the whole
</span>    <span class='comment'># document
</span>    <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='id identifier rubyid_xml'>xml</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
      <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='id identifier rubyid_header_found'>header_found</span><span class='lbracket'>[</span><span class='const'>PAR_REGEX</span><span class='rbracket'>]</span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_candidate'>candidate</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_candidate'>candidate</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(par attempt) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># Nothing yet ... let&#39;s get drastic: we look for non-par elements too,
</span>    <span class='comment'># but only for those that match something that we know is likely to
</span>    <span class='comment'># contain text
</span>
    <span class='comment'># Attempt #1
</span>    <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='id identifier rubyid_xml'>xml</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
      <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='id identifier rubyid_header_found'>header_found</span><span class='lbracket'>[</span><span class='const'>AFTER_PAR1_REGEX</span><span class='rbracket'>]</span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_candidate'>candidate</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_candidate'>candidate</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(other attempt \#1) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>

    <span class='comment'># Attempt #2
</span>    <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='id identifier rubyid_xml'>xml</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>or</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
      <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='id identifier rubyid_header_found'>header_found</span><span class='lbracket'>[</span><span class='const'>AFTER_PAR2_REGEX</span><span class='rbracket'>]</span>
      <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_candidate'>candidate</span>
      <span class='id identifier rubyid_txt'>txt</span> <span class='op'>=</span> <span class='id identifier rubyid_candidate'>candidate</span><span class='period'>.</span><span class='id identifier rubyid_ircify_html'>ircify_html</span>
      <span class='id identifier rubyid_header_found'>header_found</span> <span class='op'>=</span> <span class='backref'>$&#39;</span>
      <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_sub!'>sub!</span><span class='lparen'>(</span><span class='id identifier rubyid_strip'>strip</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_strip'>strip</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(other attempt \#2) </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Last candidate </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> has </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> spaces</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_txt'>txt</span> <span class='kw'>unless</span> <span class='id identifier rubyid_txt'>txt</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span>
    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_min_spaces'>min_spaces</span> <span class='op'>/=</span> <span class='int'>2</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parse_time_offset-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>parse_time_offset</strong>(str) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/parse_time.rb', line 160</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_parse_time_offset'>parse_time_offset</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(\d+):(\d+)(?:\:(\d+))?$</span><span class='regexp_end'>/</span></span> <span class='comment'># TODO refactor
</span>    <span class='id identifier rubyid_hour'>hour</span> <span class='op'>=</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_min'>min</span> <span class='op'>=</span> <span class='backref'>$2</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_sec'>sec</span> <span class='op'>=</span> <span class='backref'>$3</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='id identifier rubyid_later'>later</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_mktime'>mktime</span><span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span><span class='comma'>,</span> <span class='id identifier rubyid_hour'>hour</span><span class='comma'>,</span> <span class='id identifier rubyid_min'>min</span><span class='comma'>,</span> <span class='id identifier rubyid_sec'>sec</span><span class='rparen'>)</span>

    <span class='comment'># if the given hour is earlier than current hour, given timestr
</span>    <span class='comment'># must have been meant to be in the future
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_hour'>hour</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_hour'>hour</span> <span class='op'>||</span> <span class='id identifier rubyid_hour'>hour</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_hour'>hour</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_min'>min</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
      <span class='id identifier rubyid_later'>later</span> <span class='op'>+=</span> <span class='int'>60</span><span class='op'>*</span><span class='int'>60</span><span class='op'>*</span><span class='int'>24</span>
    <span class='kw'>end</span>

    <span class='kw'>return</span> <span class='id identifier rubyid_later'>later</span> <span class='op'>-</span> <span class='id identifier rubyid_now'>now</span>
  <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^(\d+):(\d+)(am|pm)$</span><span class='regexp_end'>/</span></span> <span class='comment'># TODO refactor
</span>    <span class='id identifier rubyid_hour'>hour</span> <span class='op'>=</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_min'>min</span> <span class='op'>=</span> <span class='backref'>$2</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='id identifier rubyid_ampm'>ampm</span> <span class='op'>=</span> <span class='backref'>$3</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_ampm'>ampm</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pm</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_hour'>hour</span> <span class='op'>+=</span> <span class='int'>12</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='id identifier rubyid_later'>later</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_mktime'>mktime</span><span class='lparen'>(</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span><span class='comma'>,</span> <span class='id identifier rubyid_hour'>hour</span><span class='comma'>,</span> <span class='id identifier rubyid_min'>min</span><span class='comma'>,</span> <span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_sec'>sec</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_later'>later</span> <span class='op'>-</span> <span class='id identifier rubyid_now'>now</span>
  <span class='kw'>else</span>
    <span class='const'>ParseTime</span><span class='period'>.</span><span class='id identifier rubyid_parse_period'>parse_period</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="safe_exec-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>safe_exec</strong>(command, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Execute an external program, returning a String obtained by redirecting the
program&#39;s standards errors and output</p>

<p>TODO: find a way to expose some common errors (e.g. Errno::NOENT) to the
caller</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 283</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_safe_exec'>safe_exec</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_popen'>popen</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_p'>p</span>
      <span class='kw'>break</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_readlines'>readlines</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>begin</span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_reopen'>reopen</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_exec'>exec</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exception </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_pretty_inspect'>pretty_inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> trying to run </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command'>command</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>Kernel</span><span class='op'>::</span><span class='id identifier rubyid_exit!'>exit!</span> <span class='int'>1</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exec of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command'>command</span><span class='embexpr_end'>}</span><span class='tstring_content'> failed</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Kernel</span><span class='op'>::</span><span class='id identifier rubyid_exit!'>exit!</span> <span class='int'>1</span>
    <span class='kw'>end</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>safe execution of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command'>command</span><span class='embexpr_end'>}</span><span class='tstring_content'> returned </span><span class='embexpr_beg'>#{</span><span class='gvar'>$?</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='gvar'>$?</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_output'>output</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="safe_save-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>safe_save</strong>(file) {|temp| ... }
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Safely (atomically) save to <em>file</em>, by passing a tempfile to the
block and then moving the tempfile to its final location when done.</p>

<p>call-seq: Utils.safe_save(file, &amp;block)</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>temp</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


328
329
330
331
332
333
334
335
336</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 328</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_safe_save'>safe_save</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>No safe save directory defined!</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='cvar'>@@safe_save_dir</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_basename'>basename</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_temp'>temp</span> <span class='op'>=</span> <span class='const'>Tempfile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_basename'>basename</span><span class='comma'>,</span><span class='cvar'>@@safe_save_dir</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_temp'>temp</span><span class='period'>.</span><span class='id identifier rubyid_binmode'>binmode</span>
  <span class='kw'>yield</span> <span class='id identifier rubyid_temp'>temp</span> <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
  <span class='id identifier rubyid_temp'>temp</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_rename'>rename</span><span class='lparen'>(</span><span class='id identifier rubyid_temp'>temp</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="secs_to_short-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>secs_to_short</strong>(seconds) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Turn a number of seconds into a hours:minutes:seconds e.g. 3:18:10 or
5&#39;12“ or 7s</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


211
212
213
214
215
216
217
218
219
220
221
222</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 211</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_secs_to_short'>secs_to_short</span><span class='lparen'>(</span><span class='id identifier rubyid_seconds'>seconds</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_seconds'>seconds</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='comment'># make sure it&#39;s an integer
</span>  <span class='id identifier rubyid_mins'>mins</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='int'>60</span>
  <span class='id identifier rubyid_hours'>hours</span><span class='comma'>,</span> <span class='id identifier rubyid_mins'>mins</span> <span class='op'>=</span> <span class='id identifier rubyid_mins'>mins</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='int'>60</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_hours'>hours</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%s:%s:%s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_hours'>hours</span><span class='comma'>,</span> <span class='id identifier rubyid_mins'>mins</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_mins'>mins</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%s&#39;%s\&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_mins'>mins</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%ss</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_secs'>secs</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="secs_to_string-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>secs_to_string</strong>(secs) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Turn a number of seconds into a human readable string, e.g 2 days, 3 hours,
18 minutes and 10 seconds</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 184</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_secs_to_string'>secs_to_string</span><span class='lparen'>(</span><span class='id identifier rubyid_secs'>secs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_years'>years</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='const'>SEC_PER_YR</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_years'>years</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>year</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>years</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_years'>years</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_months'>months</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='const'>SEC_PER_MNTH</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_months'>months</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>month</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>months</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_months'>months</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_days'>days</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='const'>SEC_PER_DAY</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_days'>days</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>day</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>days</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_days'>days</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_hours'>hours</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='const'>SEC_PER_HR</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_hours'>hours</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hour</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hours</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_hours'>hours</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_mins'>mins</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_divmod'>divmod</span> <span class='const'>SEC_PER_MIN</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_mins'>mins</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>minute</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>minutes</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_mins'>mins</span> <span class='op'>&gt;</span> <span class='int'>0</span>
  <span class='id identifier rubyid_secs'>secs</span> <span class='op'>=</span> <span class='id identifier rubyid_secs'>secs</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_ret'>ret</span><span class='comma'>,</span> <span class='id identifier rubyid_secs'>secs</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>second</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>seconds</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_secs'>secs</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>or</span> <span class='id identifier rubyid_ret'>ret</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_ret'>ret</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='kw'>when</span> <span class='int'>0</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Empty ret array!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>when</span> <span class='int'>1</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_ret'>ret</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>else</span>
    <span class='kw'>return</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ret'>ret</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_ret'>ret</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comma'>,</span> <span class='id identifier rubyid_ret'>ret</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> and </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="secs_to_string_case-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>secs_to_string_case</strong>(array, var, string, plural) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Auxiliary method needed by Utils.secs_to_string</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


173
174
175
176
177
178
179
180</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 173</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_secs_to_string_case'>secs_to_string_case</span><span class='lparen'>(</span><span class='id identifier rubyid_array'>array</span><span class='comma'>,</span> <span class='id identifier rubyid_var'>var</span><span class='comma'>,</span> <span class='id identifier rubyid_string'>string</span><span class='comma'>,</span> <span class='id identifier rubyid_plural'>plural</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_var'>var</span>
  <span class='kw'>when</span> <span class='int'>1</span>
    <span class='id identifier rubyid_array'>array</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1 </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_string'>string</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_array'>array</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_var'>var</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_plural'>plural</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="timeago-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>timeago</strong>(time, options = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns human readable time. Like: 5 days ago</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_about'>about</span> <span class='id identifier rubyid_one'>one</span> <span class='id identifier rubyid_hour'>hour</span> <span class='id identifier rubyid_ago'>ago</span>
</code></pre>

<p>options :start_date, sets the time to measure against, defaults to now
:date_format, used with &lt;tt&gt;to_formatted_s&lt;tt&gt;, default to
:default</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


230
231
232
233
234
235
236
237
238
239
240
241
242
243
244</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 230</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_timeago'>timeago</span><span class='lparen'>(</span><span class='id identifier rubyid_time'>time</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_start_date'>start_date</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:start_date</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_date_format'>date_format</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:date_format</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%x</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_delta'>delta</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_start_date'>start_date</span> <span class='op'>-</span> <span class='id identifier rubyid_time'>time</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_delta'>delta</span><span class='period'>.</span><span class='id identifier rubyid_abs'>abs</span> <span class='op'>&lt;</span> <span class='int'>2</span>
    <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>right now</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_distance'>distance</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_age_string'>age_string</span><span class='lparen'>(</span><span class='id identifier rubyid_delta'>delta</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_delta'>delta</span> <span class='op'>&lt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{d} from now</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span><span class='symbol'>:d</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_distance'>distance</span><span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid__'>_</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%{d} ago</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>%</span> <span class='lbrace'>{</span><span class='symbol'>:d</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_distance'>distance</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_exec-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>try_exec</strong>(command, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Try executing an external program, returning true if the run was successful
and false otherwise</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 305</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_try_exec'>try_exec</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_popen'>popen</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_p'>p</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>begin</span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_reopen'>reopen</span><span class='lparen'>(</span><span class='gvar'>$stdout</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_exec'>exec</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
      <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='const'>Kernel</span><span class='op'>::</span><span class='id identifier rubyid_exit!'>exit!</span> <span class='int'>1</span>
      <span class='kw'>end</span>
      <span class='const'>Kernel</span><span class='op'>::</span><span class='id identifier rubyid_exit!'>exit!</span> <span class='int'>1</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_debug'>debug</span> <span class='id identifier rubyid_p'>p</span><span class='period'>.</span><span class='id identifier rubyid_readlines'>readlines</span>
    <span class='kw'>end</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_debug'>debug</span> <span class='gvar'>$?</span>
  <span class='kw'>return</span> <span class='gvar'>$?</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_htmlinfo_filters-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>try_htmlinfo_filters</strong>(ds) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method runs an appropriately-crafted DataStream <em>ds</em> through
the filters in the :htmlinfo filter group, in order. If one of the filters
returns non-nil, its results are merged in <em>ds</em> and returned.
Otherwise nil is returned.</p>

<p>The input DataStream should have the downloaded HTML as primary key (:text)
and possibly a :headers key holding the resonse headers.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


661
662
663
664
665
666
667
668
669
670
671
672
673</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File '/home/apoc/projects/ruby/rbot/lib/rbot/core/utils/utils.rb', line 661</span>

<span class='kw'>def</span> <span class='const'>Utils</span><span class='period'>.</span><span class='id identifier rubyid_try_htmlinfo_filters'>try_htmlinfo_filters</span><span class='lparen'>(</span><span class='id identifier rubyid_ds'>ds</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_filters'>filters</span> <span class='op'>=</span> <span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_filter_names'>filter_names</span><span class='lparen'>(</span><span class='symbol'>:htmlinfo</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_filters'>filters</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='id identifier rubyid_cur'>cur</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='comment'># TODO filter priority
</span>  <span class='id identifier rubyid_filters'>filters</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>testing htmlinfo filter </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_n'>n</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_cur'>cur</span> <span class='op'>=</span> <span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_filter'>filter</span><span class='lparen'>(</span><span class='cvar'>@@bot</span><span class='period'>.</span><span class='id identifier rubyid_global_filter_name'>global_filter_name</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='comma'>,</span> <span class='symbol'>:htmlinfo</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_ds'>ds</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>returned </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cur'>cur</span><span class='period'>.</span><span class='id identifier rubyid_pretty_inspect'>pretty_inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_cur'>cur</span>
  <span class='rbrace'>}</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_ds'>ds</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_cur'>cur</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_cur'>cur</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Mon Mar  9 04:49:01 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.0).
</div>

  </body>
</html>